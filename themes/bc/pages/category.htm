title = "Category"
url = "/knowledge-hub/category/:category"
layout = "default"
is_hidden = 0

[blogPosts]
categoryFilter = "{{ :category }}"
postsPerPage = 6
noPostsMessage = "No posts found"
sortOrder = "published_at desc"
categoryPage = 404
postPage = 404
==
function onStart()
{

    $db_categories = Db::table('rainlab_blog_categories')->get();

    $cat_list = array();

    $valid_category = false;

    foreach ($db_categories as $category) {
        if ($category->slug == $this -> param('category')) { $valid_category = true; }
        array_push($cat_list, $category);
    }

    $this['valid_category'] = $valid_category;

    if ($valid_category) {

        $this['category_count'] = sizeof($cat_list);
        $this['categories'] = $cat_list;

        $current_category = $db_categories
                        -> where('slug', $this -> param('category'))
                        -> first();

        $this['category'] = $current_category;

        $master_table = DB::table('rainlab_blog_posts_categories')
                        -> join('rainlab_blog_posts', 'rainlab_blog_posts_categories.post_id', '=', 'rainlab_blog_posts.id')
                        -> join('backend_users', 'rainlab_blog_posts.user_id', '=', 'backend_users.id')
                        -> where('rainlab_blog_posts_categories.category_id', '=', $current_category->id)
                        -> where('rainlab_blog_posts.published', '=', 1)
                        -> select('title', 'slug', 'content_html', 'excerpt', 'first_name', 'last_name', 'published_at')
                        -> orderBy('published_at', 'desc')
                        -> take(5)
                        -> get();

        $articles = array();
        foreach ($master_table as $post) {
            array_push($articles, $post);
        }
        $this['articles'] = $articles;
    }
}
==

{% if (valid_category) %}

    <section id="sub-header">
        <div class="row top-container col-md-12">
            <div class="center-80pc">
                <h1 id="category-header">{{ category.name }}</h1>
            </div>
        </div>
    </section>

    <div class="row center-80pc">
        <section id="current-path-list">
            <div class="row col-md-12">
                <p class="current-path">
                    <a class="current-path" href="/">Home</a>
                    <span class="glyphicon glyphicon-chevron-right current-path"></span>
                    <a class="current-path" href="/knowledge-hub">The Business Hub</a>
                    <span class="glyphicon glyphicon-chevron-right current-path"></span>
                    {{ category.name }}
                </p>
            </div>
        </section>
        <div class="col-md-8">
            <section id="recent-articles">
                <div class="row">
                    <h3 class="no-margin-top">Articles</h3>
                    <p>Welcome to {{ category.name }} - here you'll find the latest articles and questions relating to {{ category.name|lower }}</p>
                </div>

                {% for article in articles %}
                    <div class="row">
                        <h2 ><a class="article-title" href="/knowledge-hub/category/{{ category.slug }}/{{ article.slug }}">{{ article.title }}</a></h2>
                    </div>
                    <div class="row">
                        <div class="col-md-4 no-gutter-left">
                            <p>Author: <strong>{{ article.first_name }} {{ article.last_name }}</strong></p>
                        </div>
                        <div class="col-md-4">
                            {% set reading_time =  (article.content_html|length // 250) + 1 %}
                            <p>Reading Time: <strong>{{ reading_time }} minutes</strong></p>
                        </div>
                    </div>
                    <div class="row">
                            <p class="article-excerpt">{{ article.excerpt }}</p>
                    </div>
                    <hr>
                {% endfor %}
            </section>
        </div>
        <div class="col-md-offset-1 col-md-3">
            <section id="category-sidebar">
                <h3 class="no-margin-top">Categories</h3>
                <br>
                <ul class="list-unstyled">
                    {% set sidebar_count = 0 %}
                    {% for category in categories %}
                        {% set sidebar_count = sidebar_count + 1 %}
                        <li><p style="font-size: 14pt"><a href="/knowledge-hub/category/{{ category.slug }}">{{ category.name }}</a></p></li>
                        {% if (sidebar_count < category_count) %}
                            <li><hr style="margin: 15px 0"></li>
                        {%  endif %}
                    {% endfor %}
                </ul>
            </section>
        </div>
    </div>

    <section id="faqs" class="center-80pc">
        <h3 class="no-margin-top">Popular FAQs:</h3>
    </section>

{% else %}
    {% content "404.htm" %}
{% endif %}